<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ø¯ÙŠ 2025-2026</title>

<style>
/* =============================
   ğŸ”¥ Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© â€” Ø£Ø²Ø±Ù‚ + Ø£Ø­Ù…Ø± + Ø£Ø¨ÙŠØ¶ + Ø£Ø³ÙˆØ¯ (Ø£Ø³Ø±Ø¹)
   ============================= */
body {
  font-family: 'Cairo', sans-serif;
  direction: rtl;
  margin: 0;
  padding-bottom: 120px;
  background: #000;
  overflow-x: hidden;
}

body::before {
  content: "";
  position: fixed;
  inset: 0;
  background:
    radial-gradient(circle at 15% 25%, rgba(0,150,255,0.78), transparent 50%),
    radial-gradient(circle at 85% 20%, rgba(255,60,60,0.78), transparent 50%),
    radial-gradient(circle at 30% 82%, rgba(255,255,255,0.55), transparent 52%),
    radial-gradient(circle at 70% 70%, rgba(0,0,0,0.65), transparent 55%);
  filter: blur(42px);
  animation: bgMove 8s infinite alternate ease-in-out;
  z-index: -2;
  pointer-events: none;
}

body::after {
  content: "";
  position: fixed;
  inset: 0;
  background: linear-gradient(135deg, rgba(0,0,0,0.35), rgba(0,0,0,0.74));
  z-index: -3;
  pointer-events: none;
}

@keyframes bgMove {
  0%   { transform: scale(1.00) translate(0,0); }
  50%  { transform: scale(1.22) translate(-55px, 40px); }
  100% { transform: scale(1.38) translate(55px, -40px); }
}

/* =============================
   ğŸš€ Splash Screen
   ============================= */
#splash {
  position: fixed;
  inset: 0;
  background: rgba(255,255,255,0.95);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  animation: splashFade 3.6s forwards;
  z-index: 9999;
}
@keyframes splashFade {
  0%,70% { opacity:1; }
  100%  { opacity:0; visibility:hidden; }
}
.splash-title { font-size: 32px; font-weight: bold; color:#007bff; }
.splash-sub   { font-size: 20px; color:#004a99; margin-top: 6px; }
.splash-year  { font-size: 15px; color:#ff7043; margin-top: 4px; }

/* =============================
   ğŸ·ï¸ Header
   ============================= */
header {
  text-align: center;
  padding: 18px;
  color: white;
  font-size: 23px;
  font-weight: bold;
  text-shadow: 0 3px 8px rgba(0,0,0,0.4);
  opacity: 0;
  animation: fadeIn 1.4s 3.0s forwards;
}
@keyframes fadeIn { to { opacity: 1; } }

/* =============================
   ğŸ” Login Box
   ============================= */
.login-box {
  width: 92%;
  max-width: 380px;
  margin: 140px auto 0;
  padding: 22px;
  text-align: center;
  border-radius: 22px;
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(22px);
  -webkit-backdrop-filter: blur(22px);
  border: 1px solid rgba(255,255,255,0.4);
  box-shadow: 0 15px 40px rgba(0,0,0,0.45);
  animation: slideIn 1.4s ease-out;
}
@keyframes slideIn {
  0%   { transform: translateY(60px); opacity:0; }
  100% { transform: translateY(0); opacity:1; }
}
.login-box input,
.login-box button {
  width: 100%;
  padding: 15px;
  font-size: 18px;
  border-radius: 14px;
  border: none;
  box-sizing: border-box;
  margin-top: 14px;
}

/* =============================
   âœ… Ù…Ù†Ø¹ Ø§Ù„Ø²ÙˆÙ… Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ù…Ù‡Ù… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„)
   ============================= */
input, select, textarea { font-size: 16px !important; }

/* Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
.login-box input {
  background: rgba(255,255,255,0.95);
  text-align: center;
  font-weight: bold;
  color: #004a99;
  box-shadow: 0 0 0 2px rgba(0,0,0,0.08);
  transition: .25s;
}
.login-box input:focus { box-shadow: 0 0 0 2px #00b0ff; }

/* Ø²Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ */
.login-box button {
  background: linear-gradient(135deg, #00d46a, #009944);
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,0.3);
  transition: 0.25s;
}
.login-box button:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 12px 28px rgba(0,0,0,0.35);
}
.login-box button:active { transform: scale(0.97); }

.error { color: #ffeb3b; font-weight: bold; margin-top: 10px; }

/* =============================
   ğŸ“„ Ø§Ù„ØµÙØ­Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
   ============================= */
.page { display: none; animation: fadePage .6s ease; }
@keyframes fadePage {
  0%   { opacity:0; transform: translateY(25px); }
  100% { opacity:1; transform: translateY(0); }
}
.section {
  padding: 15px;
  margin: 20px;
  border-radius: 18px;
  background: rgba(255,255,255,0.25);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  font-weight: bold;
  box-shadow: 0 8px 22px rgba(0,0,0,0.25);
  color: white;
}

/* =============================
   âš™ï¸ Bottom Navigation (Ø·Ø§Ù„Ø¨)
   ============================= */
#bottomBar {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  width: 92%;
  height: 72px;
  display: none;
  align-items: center;
  justify-content: space-around;
  border-radius: 28px;
  background: rgba(255,255,255,0.2);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid rgba(255,255,255,0.3);
  transition: opacity .35s ease;
  box-shadow: 0 10px 24px rgba(0,0,0,0.3);
  color: white;

  opacity: 0;
  pointer-events: none;
  z-index: 2000;
  will-change: opacity;
  isolation: isolate;
}
#bottomBar.show-bar { opacity: 1; pointer-events: auto; }

.nav-item {
  cursor: pointer;
  opacity: .7;
  font-size: 14px;
  position: relative;
  z-index: 1;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}
.nav-item:hover { opacity:1; }
.nav-item.active { opacity:1; }

/* Ø§Ù†ÙØ¬Ø§Ø± Ø¨Ø³ÙŠØ· */
.burst {
  position:absolute;
  width:12px; height:12px;
  background:white;
  border-radius:50%;
  transform:translate(-50%,-50%) scale(0);
  animation:burstAnim .5s forwards;
  pointer-events: none;
}
@keyframes burstAnim {
  0% { transform: scale(0); opacity:1; }
  100% { transform: scale(18); opacity:0; }
}

/* =============================
   âœ… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù…Ø© + Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„Ø§Øª
   ============================= */
table { width: 100%; border-collapse: collapse; }
td, th {
  padding: 10px;
  border-bottom: 1px solid rgba(255,255,255,0.4);
  font-size: 14px;
}
th { text-align: right; }

.table-input {
  width: 100%;
  padding: 8px;
  border-radius: 10px;
  border: none;
  box-sizing: border-box;
  background: rgba(255,255,255,0.92);
  color: #004a99;
}

/* =============================
   âœ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
   ============================= */
.profile-actions { display: flex; gap: 10px; margin-bottom: 15px; }
.logout-btn, .save-btn {
  flex: 1; padding: 12px; border-radius: 12px; border: none;
  font-weight: bold; cursor: pointer;
}
.logout-btn { background: #ff1744; color: white; box-shadow: 0 4px 12px rgba(244,67,54,0.6); }
.save-btn   { background: #ffd600; color: #000; box-shadow: 0 4px 12px rgba(255,214,0,0.6); }
.logout-btn:active, .save-btn:active { transform: scale(0.97); }

/* =============================
   âœ… Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (Ø·Ø§Ù„Ø¨)
   ============================= */
.grade-card {
  background: linear-gradient(135deg, #00c853, #009624);
  padding: 14px;
  margin-bottom: 18px;
  border-radius: 16px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  color: #fff;
}
.grade-title {
  font-size: 18px;
  margin-bottom: 8px;
  border-bottom: 2px solid rgba(255,255,255,0.7);
  padding-bottom: 6px;
}
.grade-row {
  display: flex;
  justify-content: space-between;
  padding: 4px 0;
  border-bottom: 1px solid rgba(255,255,255,0.35);
  font-size: 14px;
}
.grade-row:last-child { border-bottom: none; }

.grades-info-card {
  margin-top: 18px;
  padding: 12px;
  border-radius: 16px;
  background: rgba(255,255,255,0.9);
  color: #003f7d;
  box-shadow: 0 3px 12px rgba(0,0,0,0.25);
  font-size: 14px;
}
.grades-info-card p { margin: 4px 0; }

.objection-open-btn {
  width: 100%;
  margin-top: 10px;
  padding: 10px;
  border-radius: 12px;
  border: none;
  background: #00e676;
  color: #004d40;
  font-weight: bold;
  cursor: pointer;
}
.objection-open-btn:active { transform: scale(0.98); }

/* =============================
   âœ… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°
   ============================= */
.teacher-header { font-size: 20px; margin-bottom: 6px; color: #fff; }
.teacher-sub { font-size: 14px; margin-bottom: 10px; color: #e3f2fd; }

.teacher-classes-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
.teacher-class-btn {
  flex: 1 1 45%;
  padding: 12px;
  border-radius: 14px;
  border: none;
  background: linear-gradient(135deg, #00e1ff, #007bff);
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 16px rgba(0,0,0,0.25);
  transition: 0.25s;
}
.teacher-class-btn:hover { transform: translateY(-1px) scale(1.02); }

.teacher-back-btn {
  padding: 8px 14px;
  border-radius: 12px;
  border: none;
  background: rgba(255,255,255,0.85);
  color: #004a99;
  font-weight: bold;
  cursor: pointer;
  margin-bottom: 10px;
}

.teacher-table-wrapper { margin-top: 12px; overflow-x: auto; }
#teacherGradesTable { width: 1000px; max-width: 100%; border-collapse: collapse; }
#teacherGradesTable th, #teacherGradesTable td {
  padding: 7px;
  border-bottom: 1px solid rgba(255,255,255,0.35);
  white-space: nowrap;
  font-size: 13px;
}
#teacherGradesTable th { background: rgba(255,255,255,0.12); color: #e3f2fd; }

.teacher-grade-input {
  width: 70px;
  max-width: 100%;
  padding: 5px;
  border-radius: 8px;
  border: none;
  background: rgba(255,255,255,0.92);
  text-align: center;
  font-weight: bold;
  color: #004a99;
}
.teacher-grade-static {
  display: inline-block;
  min-width: 45px;
  text-align: center;
  font-weight: bold;
  color: #ffeb3b;
}
.objection-cell { color: #ffcdd2; font-size: 12px; max-width: 160px; white-space: normal; }

.teacher-actions { margin-top: 14px; display: flex; flex-direction: column; gap: 8px; }
.teacher-save-btn, .teacher-clear-btn {
  width: 100%;
  padding: 11px;
  border-radius: 14px;
  border: none;
  color: white;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 4px 14px rgba(0,0,0,0.35);
}
.teacher-save-btn { background: linear-gradient(135deg, #19e05a, #0a9b32); }
.teacher-clear-btn{ background: linear-gradient(135deg, #ef5350, #e53935); }

/* =============================
   âœ… Toast
   ============================= */
#toast {
  position: fixed;
  bottom: -60px;
  left: 50%;
  transform: translateX(-50%);
  background: #00c853;
  color: white;
  padding: 12px 20px;
  border-radius: 12px;
  font-weight: bold;
  opacity: 0;
  transition: .5s;
  z-index: 9999;
  pointer-events: none;
}
#toast.show { bottom: 26px; opacity: 1; pointer-events: auto; }

/* =============================
   âœ… Ù†Ø§ÙØ°Ø© Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶ (Modal)
   ============================= */
#objectionModal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 18px;
}
.objection-card {
  width: 100%;
  max-width: 520px;
  border-radius: 18px;
  background: rgba(255,255,255,0.16);
  backdrop-filter: blur(18px);
  -webkit-backdrop-filter: blur(18px);
  border: 1px solid rgba(255,255,255,0.30);
  box-shadow: 0 12px 30px rgba(0,0,0,0.45);
  padding: 14px;
  color: white;
}
.objection-card h3 { margin: 6px 0 10px; font-size: 18px; }
.objection-card textarea {
  width: 100%;
  min-height: 120px;
  resize: vertical;
  padding: 10px;
  border-radius: 12px;
  border: none;
  box-sizing: border-box;
  background: rgba(255,255,255,0.92);
  color: #003a6b;
  outline: none;
}
.modal-actions {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}
.modal-actions button {
  flex: 1;
  padding: 11px;
  border-radius: 12px;
  border: none;
  font-weight: bold;
  cursor: pointer;
}
.modal-cancel { background: rgba(255,255,255,0.85); color: #003a6b; }
.modal-send { background: linear-gradient(135deg, #00d46a, #009944); color: white; }
.modal-send:active, .modal-cancel:active { transform: scale(0.98); }

/* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
@media(max-width: 600px) {
  #teacherGradesTable th, #teacherGradesTable td { font-size: 11px; padding: 5px; }
  .teacher-class-btn { flex: 1 1 100%; }
}
</style>
</head>

<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© -->
<div id="splash">
  <div class="splash-title">Ù‚Ø³Ù… Ø§Ù„Ø­ÙˆÙƒÙ…Ø©</div>
  <div class="splash-sub">Ø«Ø§Ù†ÙˆÙŠØ© Ø§Ù„ØªØ­Ø¯ÙŠ Ø§Ù„Ø£Ù‡Ù„ÙŠØ©</div>
  <div class="splash-year">Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ 2025 - 2026</div>
</div>

<header>Ù…Ù†ØµØ© Ø§Ù„ØªØ­Ø¯ÙŠ 2025-2026</header>

<!-- ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="login-box" id="loginBox">
  <input id="studentCode" placeholder="  Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ">
  <button onclick="searchStudent()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  <div id="output"></div>
</div>

<!-- ØµÙØ­Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ -->
<div id="profilePage" class="page section"></div>
<div id="gradesPage" class="page section">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
<div id="notifyPage" class="page section">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¨Ù„ÙŠØºØ§Øª Ø­Ø§Ù„ÙŠØ§Ù‹</div>
<div id="chatPage" class="page section">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø­Ø§Ù„ÙŠØ§Ù‹</div>

<!-- ØµÙØ­Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø° -->
<div id="teacherClassesPage" class="page section"></div>
<div id="teacherGradesPage" class="page section"></div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø³ÙÙ„ÙŠ -->
<div id="bottomBar">
  <div class="nav-item" data-page="profilePage" onclick="showPage('profilePage', this)">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</div>
  <div class="nav-item" data-page="gradesPage"  onclick="showPage('gradesPage', this)">Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</div>
  <div class="nav-item" data-page="notifyPage"  onclick="showPage('notifyPage', this)">Ø§Ù„ØªØ¨Ù„ÙŠØºØ§Øª</div>
  <div class="nav-item" data-page="chatPage"    onclick="showPage('chatPage', this)">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</div>
</div>

<!-- Toast -->
<div id="toast">ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­ âœ“</div>

<!-- Modal: Ø§Ø¹ØªØ±Ø§Ø¶ -->
<div id="objectionModal" onclick="closeObjectionModal(true)">
  <div class="objection-card" onclick="event.stopPropagation()">
    <h3 id="objectionTitle">Ø§Ø¹ØªØ±Ø§Ø¶</h3>
    <textarea id="objectionText" placeholder="Ø§ÙƒØªØ¨ Ø§Ø¹ØªØ±Ø§Ø¶Ùƒ Ù‡Ù†Ø§..."></textarea>
    <div class="modal-actions">
      <button class="modal-cancel" onclick="closeObjectionModal(false)">Ø¥Ù„ØºØ§Ø¡</button>
      <button class="modal-send" onclick="sendObjection()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶</button>
    </div>
  </div>
</div>

<script>
/* âœ… ØºÙŠÙ‘Ø± Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ù†Ø´Ø± Ø§Ù„Ù€Web App */
const API_URL = "https://script.google.com/macros/s/AKfycbx9v4mQRU4H6hzKoW2R7sYq_gwvmhVB3PdKeRsvhCGEkAVcOjxrtMJNzEIIGklZryt2/exec";

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³ØªØ§Ø° */
let currentTeacher = null;
let currentTeacherClasses = [];
let currentTeacherSubject = "";
let currentTeacherClassName = "";

/* Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ */
let currentStudent = null;

/* Ø§Ø¹ØªØ±Ø§Ø¶ Modal state */
let currentObjectionSubject = "";

/* Toast */
function showToast(msg, error=false) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.background = error ? "#d32f2f" : "#00c853";
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2600);
}

/* âœ… Ø¯Ø¹Ù… Ù„Ù…Ø³ Ù‚ÙˆÙŠ Ù„Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø³ÙÙ„ÙŠ */
document.addEventListener("DOMContentLoaded", () => {
  const bar = document.getElementById("bottomBar");
  if (!bar) return;

  bar.addEventListener("touchend", (e) => {
    const item = e.target.closest(".nav-item");
    if (!item) return;
    e.preventDefault();
    item.click();
  }, { passive: false });

  bar.addEventListener("click", (e) => {
    const item = e.target.closest(".nav-item");
    if (!item) return;
    const page = item.getAttribute("data-page");
    if (page) showPage(page, item);
  });
});

/* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ */
window.addEventListener("DOMContentLoaded", () => {
  const savedCode = localStorage.getItem("studentCode");
  const loggedIn  = localStorage.getItem("loggedIn");
  const teacherEmail  = localStorage.getItem("teacherEmail");
  const teacherLogged = localStorage.getItem("teacherLogged");

  if (teacherLogged === "true" && teacherEmail) {
    document.getElementById("studentCode").value = teacherEmail;
    loginAsTeacher(teacherEmail, document.getElementById("output"), false);
    return;
  }

  if (loggedIn === "true" && savedCode) {
    document.getElementById("studentCode").value = savedCode;
    searchStudent(false);
  }
});

/* ============================
   Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ / Ø§Ù„Ø£Ø³ØªØ§Ø°
   ============================ */
async function searchStudent(saveSession = true) {
  let code = document.getElementById("studentCode").value.trim();
  let output = document.getElementById("output");

  if (!code) {
    output.innerHTML = "<p class='error'>âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</p>";
    return;
  }

  output.innerHTML = `<p style="color:white">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...</p>`;

  try {
    let res = await fetch(`${API_URL}?code=${encodeURIComponent(code)}`);
    let data = await res.json();

    if (data.status === "success") {
      let student = data.data;
      currentStudent = student;

      if (saveSession) {
        localStorage.setItem("loggedIn", "true");
        localStorage.setItem("studentCode", code);
        updateState(code, "ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„");
      }

      document.getElementById("loginBox").style.display = "none";

      // Ø´Ø±ÙŠØ· Ø§Ù„Ø·Ø§Ù„Ø¨
      document.getElementById("bottomBar").style.display = "flex";
      document.getElementById("bottomBar").classList.add("show-bar");

      loadProfile(student);
      loadGrades(student);

      const first = document.querySelector('#bottomBar .nav-item[data-page="profilePage"]');
      showPage('profilePage', first);

      output.innerHTML = "";
      return;
    }

    // Ù„ÙŠØ³ Ø·Ø§Ù„Ø¨ -> Ø¬Ø±Ø¨ Ø£Ø³ØªØ§Ø°
    await loginAsTeacher(code, output);
  } catch (err) {
    await loginAsTeacher(code, output);
  }
}

/* ============================
   ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°
   ============================ */
async function loginAsTeacher(email, outputElement, saveSession = true) {
  outputElement.innerHTML = `<p style="color:white">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ ÙƒØ£Ø³ØªØ§Ø°...</p>`;

  try {
    let res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: "get_teacher_info", email })
    });

    let data = await res.json();

    if (data.status !== "success") {
      outputElement.innerHTML = `<p class='error'>âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</p>`;
      return;
    }

    if (saveSession) {
      localStorage.setItem("teacherLogged", "true");
      localStorage.setItem("teacherEmail", email);
    }

    currentTeacher = data.data.teacher || {};
    currentTeacherClasses = data.data.classes || [];
    currentTeacherSubject = currentTeacher["Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© "] || currentTeacher["Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©"] || "";
    currentTeacherClassName = "";

    document.getElementById("loginBox").style.display = "none";
    document.getElementById("bottomBar").style.display = "none";

    loadTeacherClasses();
    outputElement.innerHTML = "";
    showToast("âœ” ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£Ø³ØªØ§Ø°");
  } catch (err) {
    outputElement.innerHTML = `<p class='error'>âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„</p>`;
  }
}

/* ============================
   ØµÙØ­Ø© ØµÙÙˆÙ Ø§Ù„Ø£Ø³ØªØ§Ø°
   ============================ */
function loadTeacherClasses() {
  const page = document.getElementById("teacherClassesPage");

  const teacherName = currentTeacher["Ø§Ø³Ù… Ø§Ù„Ø§Ø³ØªØ§Ø°"] || currentTeacher["Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°"] || "-";
  const subject     = currentTeacher["Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© "] || currentTeacher["Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©"] || "-";
  const email       = currentTeacher["Ø§Ù„Ø§ÙŠÙ…ÙŠÙ„"] || "-";

  let html = `
    <div class="profile-actions">
      <button onclick="teacherLogout()" class="logout-btn">ğŸ” Ø®Ø±ÙˆØ¬</button>
    </div>

    <div class="teacher-header">ğŸ‘¨â€ğŸ« Ù„ÙˆØ­Ø© Ø§Ù„Ø£Ø³ØªØ§Ø°</div>
    <div class="teacher-sub">
      <div>Ø§Ù„Ø§Ø³Ù…: <b>${teacherName}</b></div>
      <div>Ø§Ù„Ù…Ø§Ø¯Ø©: <b>${subject}</b></div>
      <div style="opacity:.8">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„: <b>${email}</b></div>
    </div>

    <div>ğŸ“š Ø§Ø®ØªØ± Ø§Ù„ØµÙ:</div>
    <div class="teacher-classes-grid">
  `;

  if (!currentTeacherClasses.length) {
    html += `<p style="color:#ffeb3b;margin-top:10px">âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ ØµÙÙˆÙ</p>`;
  } else {
    currentTeacherClasses.forEach(cls => {
      html += `<button class="teacher-class-btn" onclick="openTeacherClass('${cls}')">${cls}</button>`;
    });
  }

  html += `</div>`;
  page.innerHTML = html;

  showPage("teacherClassesPage");
}

/* ============================
   ÙØªØ­ Ø¬Ø¯ÙˆÙ„ Ø¯Ø±Ø¬Ø§Øª ØµÙ
   ============================ */
async function openTeacherClass(className) {
  const page = document.getElementById("teacherGradesPage");
  currentTeacherClassName = className;

  page.innerHTML = `<p style="color:white">â³ ØªØ­Ù…ÙŠÙ„...</p>`;
  showPage("teacherGradesPage");

  try {
    let res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        action: "get_class_grades",
        subject: currentTeacherSubject,
        className
      })
    });

    let data = await res.json();
    if (data.status !== "success") {
      page.innerHTML = `<p class='error'>âŒ ${data.data}</p>`;
      return;
    }

    renderTeacherGrades(data.data);
  } catch (err) {
    page.innerHTML = `<p class='error'>âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„</p>`;
  }
}

/* ============================
   âœ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø£Ø³ØªØ§Ø° (Ù„Ø§ ÙŠØ­Ø³Ø¨ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
   ============================ */
function toNum(v) {
  const n = parseFloat(v);
  return isNaN(n) ? 0 : n;
}
function hasVal(v) {
  return v !== null && v !== undefined && String(v).trim() !== "";
}
function calcTerm(a, b) {
  if (!hasVal(a) || !hasVal(b)) return "";
  return ((toNum(a) + toNum(b)) / 2).toFixed(2);
}
function calcSaay(term1, mid, term2, fin) {
  if (!hasVal(term1) || !hasVal(mid) || !hasVal(term2) || !hasVal(fin)) return "";
  return ((toNum(term1) + toNum(mid) + toNum(term2) + toNum(fin)) / 4).toFixed(2);
}
function calcGrade(saay) {
  if (!hasVal(saay)) return "";
  const s = parseFloat(saay);
  if (isNaN(s)) return "";
  if (s < 50) return "Ù…ÙƒÙ…Ù„";
  if (s >= 90) return "Ù…Ù…ØªØ§Ø²";
  if (s >= 80) return "Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹";
  if (s >= 70) return "Ø¬ÙŠØ¯";
  if (s >= 60) return "Ù…ØªÙˆØ³Ø·";
  return "Ø¶Ø¹ÙŠÙ";
}
function recalcRow(tr) {
  const m1  = tr.querySelector('input[data-key="month1"]')?.value ?? "";
  const m2  = tr.querySelector('input[data-key="month2"]')?.value ?? "";
  const mid = tr.querySelector('input[data-key="mid"]')?.value ?? "";
  const m3  = tr.querySelector('input[data-key="month3"]')?.value ?? "";
  const m4  = tr.querySelector('input[data-key="month4"]')?.value ?? "";
  const fin = tr.querySelector('input[data-key="final"]')?.value ?? "";

  const term1 = calcTerm(m1, m2);
  const term2 = calcTerm(m3, m4);
  const saay  = calcSaay(term1, mid, term2, fin);
  const grade = calcGrade(saay);

  const s1 = tr.querySelector('[data-static="term1"]');
  const s2 = tr.querySelector('[data-static="term2"]');
  const ss = tr.querySelector('[data-static="saay"]');
  const sg = tr.querySelector('[data-static="grade"]');

  if (s1) s1.innerText = term1;
  if (s2) s2.innerText = term2;
  if (ss) ss.innerText = saay;
  if (sg) sg.innerText = grade;
}
function bindAutoCalc() {
  const table = document.getElementById("teacherGradesTable");
  if (!table) return;

  table.querySelectorAll("tbody tr").forEach(tr => {
    recalcRow(tr);
    tr.querySelectorAll("input.teacher-grade-input").forEach(inp => {
      inp.addEventListener("input", () => recalcRow(tr));
      inp.addEventListener("change", () => recalcRow(tr));
    });
  });
}

/* ============================
   Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„Ù„Ø£Ø³ØªØ§Ø°
   ============================ */
function renderTeacherGrades(info) {
  const page = document.getElementById("teacherGradesPage");
  const subject   = info.subject;
  const className = info.className;
  let students    = info.students;

  const teacherName = currentTeacher["Ø§Ø³Ù… Ø§Ù„Ø§Ø³ØªØ§Ø°"] || currentTeacher["Ø§Ø³Ù… Ø§Ù„Ø£Ø³ØªØ§Ø°"] || "-";
  students.sort((a, b) => a.name.localeCompare(b.name, "ar"));

  let html = `
    <button class="teacher-back-btn" onclick="loadTeacherClasses()">â¬… Ø±Ø¬ÙˆØ¹</button>

    <div class="teacher-header">ğŸ“Š Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø©</div>
    <div class="teacher-sub">
      <div>Ø§Ù„Ø£Ø³ØªØ§Ø°: <b>${teacherName}</b></div>
      <div>Ø§Ù„Ù…Ø§Ø¯Ø©: <b>${subject}</b></div>
      <div>Ø§Ù„ØµÙ: <b>${className}</b></div>
    </div>

    <div class="teacher-table-wrapper">
      <table id="teacherGradesTable">
        <thead>
          <tr>
            <th>Øª</th>
            <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
            <th>Ø´Ù‡Ø±1</th>
            <th>Ø´Ù‡Ø±2</th>
            <th>ÙØµÙ„1</th>
            <th>Ù†ØµÙ Ø§Ù„Ø³Ù†Ø©</th>
            <th>Ø´Ù‡Ø±3</th>
            <th>Ø´Ù‡Ø±4</th>
            <th>ÙØµÙ„2</th>
            <th>Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
            <th>Ø§Ù„Ø³Ø¹ÙŠ</th>
            <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
            <th>Ø§Ø¹ØªØ±Ø§Ø¶</th>
          </tr>
        </thead>
        <tbody>
  `;

  students.forEach((st, i) => {
    const g = st.grades || {};
    const objection = st.objection || "";

    html += `
      <tr data-row="${st.row}">
        <td>${i+1}</td>
        <td>${st.name}</td>

        <td><input type="number" inputmode="decimal" data-key="month1" class="teacher-grade-input" value="${g.month1 ?? ""}"></td>
        <td><input type="number" inputmode="decimal" data-key="month2" class="teacher-grade-input" value="${g.month2 ?? ""}"></td>

        <td><span class="teacher-grade-static" data-static="term1">${g.term1 ?? ""}</span></td>

        <td><input type="number" inputmode="decimal" data-key="mid" class="teacher-grade-input" value="${g.mid ?? ""}"></td>

        <td><input type="number" inputmode="decimal" data-key="month3" class="teacher-grade-input" value="${g.month3 ?? ""}"></td>
        <td><input type="number" inputmode="decimal" data-key="month4" class="teacher-grade-input" value="${g.month4 ?? ""}"></td>

        <td><span class="teacher-grade-static" data-static="term2">${g.term2 ?? ""}</span></td>

        <td><input type="number" inputmode="decimal" data-key="final" class="teacher-grade-input" value="${g.final ?? ""}"></td>

        <td><span class="teacher-grade-static" data-static="saay">${g.saay ?? ""}</span></td>
        <td><span class="teacher-grade-static" data-static="grade">${g.grade ?? ""}</span></td>

        <td><span class="objection-cell">${objection}</span></td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>

    <div class="teacher-actions">
      <button class="teacher-save-btn" onclick="saveTeacherGrades()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
      <button class="teacher-clear-btn" onclick="clearObjections()">ğŸ§¹ Ø­Ø°Ù Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶Ø§Øª</button>
    </div>
  `;

  page.innerHTML = html;
  bindAutoCalc();
}

/* ============================
   Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª (ÙŠØ±Ø³Ù„ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª + Ø§Ù„Ù…Ø­Ø³ÙˆØ¨)
   ============================ */
async function saveTeacherGrades() {
  let rows = document.querySelectorAll("#teacherGradesTable tbody tr");
  let grades = [];

  rows.forEach(tr => {
    let row = parseInt(tr.getAttribute("data-row"));
    let obj = { row };

    // Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª ÙÙ‚Ø·
    tr.querySelectorAll("input").forEach(inp => {
      obj[inp.dataset.key] = inp.value;
    });

    // Ø§Ù„Ù…Ø­Ø³ÙˆØ¨
    obj.term1 = tr.querySelector('[data-static="term1"]')?.innerText ?? "";
    obj.term2 = tr.querySelector('[data-static="term2"]')?.innerText ?? "";
    obj.saay  = tr.querySelector('[data-static="saay"]')?.innerText ?? "";
    obj.grade = tr.querySelector('[data-static="grade"]')?.innerText ?? "";

    grades.push(obj);
  });

  try {
    let res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        action: "save_grades",
        subject: currentTeacherSubject,
        className: currentTeacherClassName,
        grades
      })
    });

    let data = await res.json();
    if (data.status === "success") showToast("âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª");
    else showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸", true);
  } catch (e) {
    showToast("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", true);
  }
}

/* ============================
   Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶Ø§Øª
   ============================ */
async function clearObjections() {
  try {
    let res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        action: "clear_objections",
        subject: currentTeacherSubject,
        className: currentTeacherClassName
      })
    });

    let data = await res.json();

    if (data.status === "success") {
      showToast("âœ” ØªÙ… Ø­Ø°Ù Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶Ø§Øª");
      openTeacherClass(currentTeacherClassName);
    } else {
      showToast("âŒ ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶Ø§Øª", true);
    }
  } catch (e) {
    showToast("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", true);
  }
}

/* ============================
   ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
   ============================ */
async function updateState(code, state) {
  try {
    await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action: "update_state", code, state })
    });
  } catch (e) {}
}

/* ============================
   ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬
   ============================ */
function teacherLogout() {
  localStorage.removeItem("teacherLogged");
  localStorage.removeItem("teacherEmail");
  location.reload();
}
function logout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("studentCode");
  location.reload();
}

/* ============================
   Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙØ­Ø§Øª
   ============================ */
function showPage(id, element=null) {
  document.querySelectorAll(".page").forEach(p => p.style.display="none");
  document.getElementById(id).style.display="block";

  document.querySelectorAll(".nav-item").forEach(n => n.classList.remove("active"));
  if (element) {
    element.classList.add("active");
    let burst = document.createElement("span");
    burst.classList.add("burst");
    element.appendChild(burst);
    setTimeout(()=>burst.remove(), 500);
  }
}

/* ============================
   ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ (Ø·Ø§Ù„Ø¨)
   âœ… Ø­Ù‚Ù„ "Ø±Ù‚Ù… Ø§Ù„Ø®Ø·" ÙŠØ·Ø§Ø¨Ù‚ Sh1
   ============================ */
function loadProfile(st) {
  const code = st["ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨"];

  document.getElementById("profilePage").innerHTML = `
    <div class="profile-actions">
      <button onclick="logout()" class="logout-btn">ğŸ” Ø®Ø±ÙˆØ¬</button>
      <button onclick="saveChanges('${code}')" class="save-btn">ğŸ’¾ Ø­ÙØ¸</button>
    </div>

    <h3>Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>

    <table>
      <tr><th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><td>${st["Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"] || ""}</td></tr>
      <tr><th>Ø§Ù„ØµÙ</th><td>${st["Ø§Ù„ØµÙ"] || ""}</td></tr>
      <tr><th>Ø§Ù„Ù‚Ø§Ø¹Ø©</th><td>${st["Ø§Ù„Ù‚Ø§Ø¹Ø©"] || ""}</td></tr>

      <tr>
        <th>Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</th>
        <td><input id="Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯" class="table-input" type="date" value="${fixDate(st["Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯"])}"></td>
      </tr>

      <tr><th>Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</th>
        <td><input id="Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±" class="table-input" value="${st["Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±"] || ""}"></td>
      </tr>

      <tr><th>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
        <td><input id="Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" class="table-input" value="${st["Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"] || ""}"></td>
      </tr>

      <tr><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
        <td><input id="Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" class="table-input" value="${st["Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"] || ""}"></td>
      </tr>

      <tr><th>Ø§Ø³Ù… Ø§Ù„Ø£Ù…</th>
            <td><input id="Ø§Ø³Ù… Ø§Ù„Ø§Ù…" class="table-input" inputmode="numeric"
            placeholder="Ø§Ø³Ù… Ø§Ù„Ø§Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ "
            value="${st["Ø§Ø³Ù… Ø§Ù„Ø§Ù…"] || ""}">
            
      </tr>

      <tr><th>Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù†Ù‡Ø§</th>
        <td><input id="Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù†Ù‡Ø§" class="table-input" value="${st["Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù†Ù‡Ø§"] || ""}"></td>
      </tr>

      <tr><th>Ø§Ù„ÙƒØªØ¨</th><td>${st["Ø§Ù„ÙƒØªØ¨"] || ""}</td></tr>
      <tr><th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><td>${st["Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª"] || ""}</td></tr>

      <tr><th>Ø§Ù„Ø±Ù…Ø²</th>
        <td><input id="Ø§Ù„Ø±Ù…Ø²" class="table-input" inputmode="numeric"
            placeholder="Ø±Ù…Ø² Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø§ Ø§Ø­Ø¯ ØºÙŠØ±Ùƒ ÙŠØ³ØªØ·ÙŠØ¹ Ø§Ù„ØªØ­Ø¯Ø« Ø¨Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø¨Ø§Ø³Ù…Ùƒ"
            value="${st["Ø§Ù„Ø±Ù…Ø²"] || st["Ø§Ù„Ø±Ù…Ø² "] || ""}">
        </td>
      </tr>

      <tr><th>Ø±Ù‚Ù… Ø§Ù„Ø®Ø·</th>
        <td><input id="Ø±Ù‚Ù… Ø§Ù„Ø®Ø·" class="table-input" inputmode="numeric"
            placeholder="Ø±Ù‚Ù… Ø®Ø· Ø§Ù„Ù†Ù‚Ù„ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ø§Ù„Ø¨"
            value="${st["Ø±Ù‚Ù… Ø§Ù„Ø®Ø·"] || ""}">
        </td>
      </tr>
    </table>
  `;
}

/* ============================
   Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
   ============================ */
async function saveChanges(code) {
  const data = {
    "Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯": document.getElementById("Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯").value,
    "Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±": document.getElementById("Ø±Ù‚Ù… ÙˆÙ„ÙŠ Ø§Ù„Ø§Ù…Ø±").value,
    "Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨": document.getElementById("Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ù„Ø¨").value,
    "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†": document.getElementById("Ø§Ù„Ø¹Ù†ÙˆØ§Ù†").value,
    "Ø§Ø³Ù… Ø§Ù„Ø§Ù…": document.getElementById("Ø§Ø³Ù… Ø§Ù„Ø§Ù…").value,
    "Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù†Ù‡Ø§": document.getElementById("Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù†Ù‡Ø§").value,
    "Ø§Ù„Ø±Ù…Ø²": document.getElementById("Ø§Ù„Ø±Ù…Ø²").value,
    "Ø±Ù‚Ù… Ø§Ù„Ø®Ø·": document.getElementById("Ø±Ù‚Ù… Ø§Ù„Ø®Ø·").value
  };

  try {
    await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({ action:"update", code, data })
    });

    showToast("âœ” ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
    await searchStudent(false);
  } catch (e) {
    showToast("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", true);
  }
}

/* ============================
   Ø¥ØµÙ„Ø§Ø­ ØµÙŠØºØ© Ø§Ù„ØªØ§Ø±ÙŠØ®
   ============================ */
function fixDate(dateStr) {
  if (!dateStr) return "";
  let parsed = Date.parse(dateStr);
  if (isNaN(parsed)) return "";
  let d = new Date(parsed);
  let yyyy = d.getFullYear();
  let mm = String(d.getMonth()+1).padStart(2,'0');
  let dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}

/* ============================
   Ø§Ø¹ØªØ±Ø§Ø¶ Modal
   ============================ */
function openObjectionModal(subjectName) {
  currentObjectionSubject = subjectName;
  document.getElementById("objectionTitle").innerText = `Ø§Ø¹ØªØ±Ø§Ø¶ Ø¹Ù„Ù‰ Ù…Ø§Ø¯Ø©: ${subjectName}`;
  document.getElementById("objectionText").value = "";
  document.getElementById("objectionModal").style.display = "flex";
  setTimeout(() => document.getElementById("objectionText").focus(), 0);
}
function closeObjectionModal() {
  document.getElementById("objectionModal").style.display = "none";
  currentObjectionSubject = "";
}

async function sendObjection() {
  if (!currentStudent) return showToast("âŒ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨", true);

  const code = currentStudent["ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨"] || localStorage.getItem("studentCode") || "";
  if (!code) return showToast("âŒ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯", true);

  const subject = currentObjectionSubject;
  if (!subject) return showToast("âŒ Ù…Ø§Ø¯Ø© ØºÙŠØ± Ù…Ø­Ø¯Ø¯Ø©", true);

  const objectionText = document.getElementById("objectionText").value.trim();
  if (!objectionText) return showToast("âš ï¸ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶ Ø£ÙˆÙ„Ø§Ù‹", true);

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify({
        action: "submit_objection",
        code,
        subject,
        objection: objectionText
      })
    });

    const data = await res.json();
    if (data.status === "success") {
      showToast("âœ” ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶");
      closeObjectionModal();

      await searchStudent(false);
      const gradesTab = document.querySelector('#bottomBar .nav-item[data-page="gradesPage"]');
      showPage("gradesPage", gradesTab);
    } else {
      showToast("âŒ ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø¹ØªØ±Ø§Ø¶: " + (data.data || ""), true);
    }
  } catch (e) {
    showToast("âŒ Ø®Ø·Ø£ Ø§ØªØµØ§Ù„", true);
  }
}

/* ============================
   ØªØ­Ù…ÙŠÙ„ Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ + Ø²Ø± Ø§Ø¹ØªØ±Ø§Ø¶ ØªØ­Øª ÙƒÙ„ Ù…Ø§Ø¯Ø©
   ============================ */
function loadGrades(st) {
  let html = ``;

  const subjects = {
    "Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©": ["Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø´Ù‡Ø± 1","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø´Ù‡Ø± 2","Ø§Ø³Ù„Ø§Ù…ÙŠØ© ÙØµÙ„ 1","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ù†ØµÙ Ø³Ù†Ø©","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø´Ù‡Ø± 3","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø´Ù‡Ø± 4","Ø§Ø³Ù„Ø§Ù…ÙŠØ© ÙØµÙ„ 2","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ø³Ù„Ø§Ù…ÙŠØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø¹Ø±Ø¨ÙŠ": ["Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø´Ù‡Ø± 1","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø´Ù‡Ø± 2","Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙØµÙ„ 1","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø´Ù‡Ø± 3","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø´Ù‡Ø± 4","Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙØµÙ„ 2","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø¹Ø±Ø¨ÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ": ["Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø´Ù‡Ø± 1","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø´Ù‡Ø± 2","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ ÙØµÙ„ 1","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø´Ù‡Ø± 3","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø´Ù‡Ø± 4","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ ÙØµÙ„ 2","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø§Ù†ÙƒÙ„ÙŠØ²ÙŠ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª": ["Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø´Ù‡Ø± 1","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø´Ù‡Ø± 2","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙØµÙ„ 1","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø´Ù‡Ø± 3","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø´Ù‡Ø± 4","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª ÙØµÙ„ 2","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡": ["Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø´Ù‡Ø± 1","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø´Ù‡Ø± 2","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ ÙØµÙ„ 1","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø´Ù‡Ø± 3","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø´Ù‡Ø± 4","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ ÙØµÙ„ 2","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„ÙƒÙŠÙ…ÙŠØ§Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡": ["Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø´Ù‡Ø± 1","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø´Ù‡Ø± 2","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙØµÙ„ 1","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø´Ù‡Ø± 3","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø´Ù‡Ø± 4","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ ÙØµÙ„ 2","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø§Ø­ÙŠØ§Ø¡": ["Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø´Ù‡Ø± 1","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø´Ù‡Ø± 2","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ ÙØµÙ„ 1","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø´Ù‡Ø± 3","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø´Ù‡Ø± 4","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ ÙØµÙ„ 2","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø§Ø­ÙŠØ§Ø¡ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª": ["Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø´Ù‡Ø± 1","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø´Ù‡Ø± 2","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª ÙØµÙ„ 1","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø´Ù‡Ø± 3","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø´Ù‡Ø± 4","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª ÙØµÙ„ 2","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø­Ø§Ø³ÙˆØ¨": ["Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø´Ù‡Ø± 1","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø´Ù‡Ø± 2","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ ÙØµÙ„ 1","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø´Ù‡Ø± 3","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø´Ù‡Ø± 4","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ ÙØµÙ„ 2","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø­Ø§Ø³ÙˆØ¨ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø±ÙŠØ§Ø¶Ø©": ["Ø±ÙŠØ§Ø¶Ø© Ø´Ù‡Ø± 1","Ø±ÙŠØ§Ø¶Ø© Ø´Ù‡Ø± 2","Ø±ÙŠØ§Ø¶Ø© ÙØµÙ„ 1","Ø±ÙŠØ§Ø¶Ø© Ù†ØµÙ Ø³Ù†Ø©","Ø±ÙŠØ§Ø¶Ø© Ø´Ù‡Ø± 3","Ø±ÙŠØ§Ø¶Ø© Ø´Ù‡Ø± 4","Ø±ÙŠØ§Ø¶Ø© ÙØµÙ„ 2","Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø±ÙŠØ§Ø¶Ø© Ø§Ù„Ø³Ø¹ÙŠ","Ø±ÙŠØ§Ø¶Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„ÙÙ†ÙŠØ©": ["Ø§Ù„ÙÙ†ÙŠØ© Ø´Ù‡Ø± 1","Ø§Ù„ÙÙ†ÙŠØ© Ø´Ù‡Ø± 2","Ø§Ù„ÙÙ†ÙŠØ© ÙØµÙ„ 1","Ø§Ù„ÙÙ†ÙŠØ© Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„ÙÙ†ÙŠØ© Ø´Ù‡Ø± 3","Ø§Ù„ÙÙ†ÙŠØ© Ø´Ù‡Ø± 4","Ø§Ù„ÙÙ†ÙŠØ© ÙØµÙ„ 2","Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„ÙÙ†ÙŠØ© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"],
    "Ø§Ù„Ø³Ù„ÙˆÙƒ": ["Ø§Ù„Ø³Ù„ÙˆÙƒ Ø´Ù‡Ø± 1","Ø§Ù„Ø³Ù„ÙˆÙƒ Ø´Ù‡Ø± 2","Ø§Ù„Ø³Ù„ÙˆÙƒ ÙØµÙ„ 1","Ø§Ù„Ø³Ù„ÙˆÙƒ Ù†ØµÙ Ø³Ù†Ø©","Ø§Ù„Ø³Ù„ÙˆÙƒ Ø´Ù‡Ø± 3","Ø§Ù„Ø³Ù„ÙˆÙƒ Ø´Ù‡Ø± 4","Ø§Ù„Ø³Ù„ÙˆÙƒ ÙØµÙ„ 2","Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù† Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ","Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø³Ø¹ÙŠ","Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„ØªÙ‚Ø¯ÙŠØ±"]
  };

  for (let sub in subjects) {
    html += `<div class="grade-card">
      <div class="grade-title">${sub}</div>
    `;

    subjects[sub].forEach(col => {
      html += `
        <div class="grade-row">
          <span>${col}</span>
          <span>${st[col] || "-"}</span>
        </div>`;
    });

    html += `
      <button class="objection-open-btn" onclick="openObjectionModal('${sub}')">âœï¸ Ø§Ø¹ØªØ±Ø§Ø¶ Ø¹Ù„Ù‰ Ù…Ø§Ø¯Ø© (${sub})</button>
    `;

    html += `</div>`;
  }

  html += `
    <div class="grades-info-card">
      <p>ğŸ”µ Ø§Ù„ØºÙŠØ§Ø¨: <b>${st["Ø§Ù„ØºÙŠØ§Ø¨"] || "-"}</b></p>
      <p>ğŸ”µ Ø§Ù„Ù…Ø´Ø§ÙƒÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©: <b>${st["Ø§Ø®ØªÙ„Ø§Ù‚ Ù…Ø´Ø§ÙƒÙ„ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©"] || "-"}</b></p>
      <p>ğŸ”µ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ±Øª: <b>${st["Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ±Øª"] || "-"}</b></p>
      <p>ğŸ”µ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø©: <b>${st["Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ù†ØªÙŠØ¬Ø©"] || "-"}</b></p>
    </div>
  `;

  document.getElementById("gradesPage").innerHTML = html;
}
</script>

</body>
</html>
